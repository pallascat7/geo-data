---
title: "Geo-data and methods in R"
author: ""
date: "2023-02-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#The Set Up (of code)

## Set up 1: making a species distribution map
###Packages
```{r packages, echo=FALSE}
	#install.packages('dismo')  
	#install.packages('rworldmap')
	#install.packages('sf')
	#install.packages('geodata')
	
library(dismo)
library(rworldmap)
library(sf)
library(geodata)
library(raster)

```

```{r plotting world map}
	wrld_simpl<-getMap(resolution = "coarse")
	plot(wrld_simpl)
```
species to choose: Tegeticula yuccasella and yucca glauca

```{r choosing my species}
species1.gbif <- gbif("Tegeticula","yuccasella", geo=TRUE) 

species2.gbif <- gbif("yucca", "glauca", geo = TRUE)
```
```{r getting the latitude and longitude values}
species.coords1<-cbind(species1.gbif$lon,species1.gbif$lat) #species1.gbif 
species.coords2<-cbind(species2.gbif$lon,species2.gbif$lat) #species2.gbif
```
```{r removing nas}
species.coords1<-na.omit(species.coords1) #species.coords1 
species.coords1<-data.frame(species.coords1)
colnames(species.coords1)<-c("lon","lat")
	
species.coords2<-na.omit(species.coords2) #species.coords2
species.coords2<-data.frame(species.coords2)
colnames(species.coords2)<-c("lon","lat")
```
```{r plotting species distribution, echo=FALSE}

plot(wrld_simpl, xlim=range(species.coords1$lon), ylim=range(species.coords1$lat), axes=TRUE, col="lightyellow")
points(species.coords1, col='#ff0660', cex=0.75)

plot(wrld_simpl, xlim=range(species.coords2$lon), ylim=range(species.coords2$lat), axes=TRUE, col="lightyellow")
	points(species.coords2, col='#06FFA5', cex=0.75)
```
species 2 - in Sweden -> crop 
```{r trimming the coordinates, hide = TRUE}
trim.coords<-function (x,latmin,latmax,lonmin,lonmax) {
if (sum(x$lon < lonmin)>0) {
			tmp<-which(x$lon < lonmin)
			x<-x[-tmp,]}
				if (sum(x$lon > lonmax)>0) {
				tmp<-which(x$lon > lonmax)
				x<-x[-tmp,]}
					if (sum(x$lat < latmin)>0) {
					tmp<-which(x$lat < latmin)
					x<-x[-tmp,]}
						if (sum(x$lat > latmax)>0) {
						tmp<-which(x$lat > latmax)
						x<-x[-tmp,]}
				return(x)}

```
```{r checking the changed coordinates, echo=FALSE, hide = TRUE}
species.coords2.trim<-trim.coords(species.coords2,latmin=10,latmax= 65,lonmin= -125,lonmax= -70)
plot(wrld_simpl, xlim=range(species.coords2.trim$lon), ylim=range(species.coords2.trim$lat), axes=TRUE, col="lightyellow")
points(species.coords2.trim, col='#06FFA5', cex=0.75)

species.coords2<- species.coords2.trim
```
```{r plotttt}
par(mfrow = c(1,2))
plot(wrld_simpl, xlim=range(species.coords1$lon), ylim=range(species.coords1$lat), axes=TRUE, col="light yellow")
points(species.coords1, col='#ff0660', cex=0.75)

plot(wrld_simpl, xlim=range(species.coords2$lon), ylim=range(species.coords2$lat), axes=TRUE, col="light yellow")
	points(species.coords2, col='#06FFA5', cex=0.75)
```

## Set up 2: Extract climatic values for the localities occupied by the species
```{r}
bio.data<-worldclim_global(var="bio",res=10,path=getwd())
	names(bio.data)<-paste0("bio",1:19)
plot(bio.data,1)
plot(bio.data,2)
#---
# bioclimatic data for Species 1 and Species 2
bio.values1 <- extract(bio.data, species.coords1)[,-1] #bio.data1
rownames(bio.values1)<-rownames(species.coords1)

bio.values2 <- extract(bio.data, species.coords2)[,-1] #bio.data2
rownames(bio.values2)<-rownames(species.coords2)
```

```{r}
species1.data<-cbind(species.coords1,bio.values1) #species1.data
species1.data<-na.omit(species1.data)
write.csv(species1.data,file="species1.data.csv")

species2.data<-cbind(species.coords2,bio.values2) #species2.data
species2.data<-na.omit(species2.data)
write.csv(species2.data,file="species2.data.csv")
```

## Set up 3: Preparation for linear models
```{r}
pairs(bio.values1[,1:5])
pairs(bio.values2[,1:5])

#BIO1 = Annual Mean Temperature
#BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))
#BIO3 = Isothermality (BIO2/BIO7) (×100)
#BIO4 = Temperature Seasonality (standard deviation ×100)
#BIO5 = Max Temperature of Warmest Month
```
```{r}
pairs(bio.values1[,6:10])
pairs(bio.values2[,6:10])

#BIO6 = Min Temperature of Coldest Month
#BIO7 = Temperature Annual Range (BIO5-BIO6)
#BIO8 = Mean Temperature of Wettest Quarter
#BIO9 = Mean Temperature of Driest Quarter
#BIO10 = Mean Temperature of Warmest Quarter
```
```{r gathering mean, minium and maximum values}
rbind(mean=colMeans(species1.data),
	min=apply(species1.data, 2, min),
	max=apply(species1.data, 2, max))

rbind(mean=colMeans(species2.data),
	min=apply(species2.data, 2, min),
	max=apply(species2.data, 2, max))
```
```{r}
ext <- extent(wrld_simpl)
xy <- abs(apply(as.matrix(bbox(ext)), 1, diff))
n <- 5
r <- raster(ext, ncol=xy[1]*n, nrow=xy[2]*n)
mask <-rasterize(wrld_simpl, r)

e <- extent(-125, -70, 25, 55)
bg1 <- randomPoints(mask, 500, ext=e,extf=1)
colnames(bg1)<-c("lon","lat")

plot(mask, axes = TRUE, col = "lightgrey",
     xlim = c(-125, -70),
     ylim = c(25, 55)); box()
points(species.coords2,col = "#06FFA5", pch = 20, cex = 1)

plot(e, add=TRUE, col='black')

bg2 <- randomPoints(mask, 500, ext=e,extf=1)
points(bg2,col="black", pch=20)
colnames(bg2)<-c("lon","lat")

#the black points are the background points with no recorded presence in GBIF
#the pink/green points are the observed localities
bio.data<-crop(bio.data,e)
 #tip: needs ti be in the same chunk or it wonnt work
```
```{r}
train1 <- rbind(species.coords1, bg1) #train1, bg1
train2 <- rbind(species.coords2, bg2) #train2, bg

pb_train1 <- c(rep(1, nrow(species.coords1)), rep(0, nrow(bg1))) #pb_train1
pb_train2 <- c(rep(1, nrow(species.coords2)), rep(0, nrow(bg2))) #pb_train2

envtrain1 <- extract(bio.data, train1) #envtrain1
envtrain1 <- data.frame(cbind(pa1=pb_train1, envtrain1))

envtrain2 <- extract(bio.data, train2) #envtrain2
envtrain2 <- data.frame(cbind(pa2=pb_train2, envtrain2))

testpres1 <- data.frame( extract(bio.data, species.coords1) ) #testpres1
testbackg1 <- data.frame( extract(bio.data, bg1)) #testbackg1

testpres2 <- data.frame( extract(bio.data, species.coords2) ) #testpres2
testbackg2 <- data.frame( extract(bio.data, bg2)) #testbackg2

```

#Question 1: Run linear models to predict the present-day distribution of species 1 using climate variables and use them to present a map of its current distribution. Which set of climatic variables best explain the current distribution of the species?

```{r}
plot(mask, axes = TRUE, col = "lightgrey",
     xlim = c(-125, -70),
     ylim = c(25, 55)); box()
points(species.coords1,col = "#ff0660", pch = 20, cex = 1)

plot(e, add=TRUE, col='black')
points(bg1,col="black", pch=20)
```
pink =  
black = 
##Linear model
```{r linear model}
#nomenculture: gm# (species)_end climate variable
gm1_5 <- glm(pa1 ~ bio1 + bio2 + bio3 + bio4 + bio5, #pa1, envtrain1
     family = binomial(link = "logit"), data=envtrain1)
summary(gm1_5)
```
##Predict species distribution from the model and plot it
```{r BIO 1-5 plots}
pg1_5 <- predict(bio.data, gm1_5, ext=e,type="response") #pg1_5
pg1_5<-crop(pg1_5,e)

ge1_5 <- evaluate(testpres1, testbackg1, gm1_5) #ge1_5
ge1_5
#use this evaluation to pick a threshold probability for defining presence/absence
#using the model that gives the most accurate match to observed presence/absence
tr1_5 <- threshold(ge1_5, 'prevalence') #tr1_5

#representing the probability of occurrence from our linear model, for or area of extent e
par(mfrow = c(1,2))
plot(pg1_5, main='GLM probability of occurrence of species 1 associated via BIO1-5')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)

#colours: #660226 is a shade of #ff0660


plot(pg1_5 > tr1_5, main='presence/absence of Species 1 (1-5)')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)
```
AUC: 
COR: 

```{r lm bioclimate varibales 6 - 10}
gm1_10 <- glm(pa1 ~ bio6 + bio7 + bio8 + bio9 + bio10, #pa1 envtrain1
     family = binomial(link = "logit"), data=envtrain1)
summary(gm1_10)
```
```{r BIO 6 - 10 plots}
pg1_10 <- predict(bio.data, gm1_10, ext=e,type="response") #pg1_10
pg1_10<-crop(pg1_10,e)
ge1_10 <- evaluate(testpres1, testbackg1, gm1_10) #ge1_10
ge1_10
tr1_10 <- threshold(ge1_10, 'prevalence') #tr1_10



#colours: #660226 is a shade of #ff0660
#use this evaluation to pick a threshold probability for defining presence/absence
#using the model that gives the most accurate match to observed presence/absence

par(mfrow = c(1,2))
plot(pg1_10, main='GLM probability of occurrence of BIO6-10 on species 1')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)

plot(pg1_10 > tr1_10, main='presence/absence of species 1 (6-10)')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)
```
```{r eval }
AIC(gm1_5,gm1_10)
evaluate(testpres1, testbackg1, gm1_5) #testpres1, testbackg1, gm1_5
evaluate(testpres1, testbackg1, gm1_10)#testpres1, testbackg1, gm1_10
```
```{r all plots together now}
par(mfrow = c(2,2))
plot(pg1_5, main='GLM probability of occurrence of species 1 associated via BIO1-5')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)

plot(pg1_5 > tr1_5, main='presence/absence of Species 1 (1-5)')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)

plot(pg1_10, main='GLM probability of occurrence of BIO6-10 on species 1')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)

plot(pg1_10 > tr1_10, main='presence/absence species 1 (6-10)'')
plot(wrld_simpl, add=TRUE, border='dark grey') 
points(species.coords1,col = "#660226", pch = 4, cex = 0.5)
```

## Making a better prediction using linear models 
### Climate variables 1 -5
```{r}
#summary(gm1_5)
gm1_5_2 <- glm(pa1 ~  bio4 + bio5,
     family = binomial(link = "logit"), data=envtrain1)
summary(gm1_5_2)
evaluate(testpres1, testbackg1, gm1_5_2)
```

#Question 2: Run linear models to predict the present-day distribution of species 2 using climate variables and use them to present maps of its current distribution. Which set of climatic variables best explain the current distribution of the species?
```{r Species 2 distribution with random background points}
plot(mask, axes = TRUE, col = "lightgrey",
     xlim = c(-125, -70),
     ylim = c(25, 55)); box()
points(species.coords2,col = "#06FFA5", pch = 20, cex = 1)

plot(e, add=TRUE, col='black')
points(bg2,col="black", pch=20)

#has to be in the same chunk or wont work
```
```{r linear model}
gm2_5 <- glm(pa2 ~  bio1 + bio2 + bio3 + bio4 + bio5, #gm2_5 pa2 envtrain2
     family = binomial(link = "logit"), data=envtrain2)
summary(gm2_5)
```

##Predict species distribution from the model and plot it
```{r}
pg2_5 <- predict(bio.data, gm2_5, ext=e,type="response") #pg2_5
pg2_5<-crop(pg2_5,e)

ge2_5 <- evaluate(testpres2, testbackg2, gm2_5) #ge2_5
ge2_5

tr2_5 <- threshold(ge2_5, 'prevalence') #tr2_5

#representing the probability of occurrence from our linear model, for or area of extent e
#colours: #014c31 is a shade of ##06ffa5
#use this evaluation to pick a threshold probability for defining presence/absence
#using the model that gives the most accurate match to observed presence/absence
par(mfrow = c(1,2))

plot(pg2_5, main='GLM probability of occurrence of species 2 (BIO 1-5)')
plot(wrld_simpl, add=TRUE, border='darkgrey')
points(species.coords1,col = "#014c31", pch = 4, cex = 0.5)

tr2_5 <- threshold(ge2_5, 'prevalence')
plot(pg2_5 > tr2_5, main='presence/absence of species 2 (BIO 6-10)') #pg2_5,ge2_5 tr2_5
plot(wrld_simpl, add=TRUE, border='darkgrey') 
points(species.coords2,col = "#014c31", pch = 4, cex = 0.5)
```
```{r}
gm2_10 <- glm(pa2 ~ bio6 + bio7 + bio8 + bio9 + bio10, #gm2_10 pa2. envtrain2
     family = binomial(link = "logit"), data=envtrain2)
summary(gm2_10)
```
```{r}
pg2_10 <- predict(bio.data, gm2_10, ext=e,type="response") 
pg2_10<-crop(pg2_10,e)
ge2_10 <- evaluate(testpres2, testbackg2, gm2_10)
ge2_10
tr2_10 <- threshold(ge2_10, 'prevalence')

#pg2_10,ge2_10, tr2_10
#representing the probability of occurrence from our linear model, for or area of extent e


#colours: #014c31 is a shade of ##06ffa5
#use this evaluation to pick a threshold probability for defining presence/absence
#using the model that gives the most accurate match to observed presence/absence
par(mfrow = c(1,2))
plot(pg2_10, main='GLM probability of occurrence of species 2 (BIO6-10)')
plot(wrld_simpl, add=TRUE, border='dark grey')
points(species.coords2,col = "#014c31", pch = 4, cex = 0.5)

plot(pg2_10 > tr2_10, main='presence/absence of species 2 (BIO 6-10)')
plot(wrld_simpl, add=TRUE, border='darkgrey')
points(species.coords2,col = "#014c31", pch = 4, cex =0.5) #pg2_10,ge2_10, tr2_10
```
```{r}
AIC(gm2_5,gm2_10)
evaluate(testpres2, testbackg2, gm2_5)#testpres2, testbackg2, gm2_5
evaluate(testpres2, testbackg2, gm2_10)#testpres2, testbackg2, gm2_10
```
```{rall the plots together now }

```


